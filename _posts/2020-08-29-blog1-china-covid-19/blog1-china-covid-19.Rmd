---
title: "Can we go out now?"
description: |
  With the COVID-19 outbreak worldwide, what is the current situation in China? Do we need to panic? This post briefly tells the story behind the numbers for COVID-19 in China through tables. 
author:
  - name: Cuiping Wei
    url: https://tira-awsome-story.netlify.app
date: August 30, 2020
categories: 
  - COVID-19
output:
  distill::distill_article:
    self_contained: false
bibliography: references.bib
preview: images/COVID-19.png
resources:
  exclude:
    data/
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load-libraries}
library(coronavirus)
library(tidyverse)
library(DT)
library(formattable)
library(plotly)
library(lubridate)
library(knitr)
library(dplyr)
library(sparkline)
library(reactable)
library(htmltools)
library(kableExtra)
```

## Data acquisition

### COVID-19 data
The incidence data is obtained from R package `coronavirus`[@coronavirus] provided by RamiKrispin, which contains COVID-19 data from 188 countries or regions, and the raw data collected and arranged by the Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE). In this blog, I will focus on China data, which contains 22,440 observations from 2020-01-22 to 2020-08-28.   

```{r read-covid19-data}
# read data
data("coronavirus")

# daily data for all province in China
covid19_chn<-coronavirus %>% 
  filter(date <= '2020-08-28') %>% 
  filter(country %in% c("China","Taiwan*")) %>% 
  mutate(province = ifelse(country=="Taiwan*", "Taiwan", province),
         country = ifelse(country=="Taiwan*", "China", country)) %>% 
  mutate(month = month(date, label = TRUE))
```

### Population data

The population data is collected by the United Nations Department for Economic and Social Affairs(UNDESA). I downloaded and obtained the population of China in 2019 from [UNDESA]("https://population.un.org/wpp/Download/Standard/CSV/")[@desa2019world].   

```{r}
#read population data
world_population <- read_csv(here::here("data/WPP2019_TotalPopulationBySex.csv")) 

# filter China
pop_chn <- world_population %>% 
  filter(Location == "China",
         Time == 2019) %>% 
  select(PopTotal)

```


## Analysis


```{r covid-rate}
# calculate rate for confirmed, death, recovered and active
# ause all the proportion is too small, so all added 0.1
covid_rate<-covid19_chn %>% 
  group_by(type,month) %>%
  summarise(total_cases = sum(cases)) %>%
  pivot_wider(names_from = type, 
              values_from = total_cases) %>%
  mutate(active = confirmed - death - recovered) %>%
  mutate(active_total = cumsum(active),
         population = pop_chn$PopTotal*1000) %>%
  mutate(confirmed_rates = ((1000*confirmed/population) + 0.01),
         active_rates = ((1000*active_total/population) +0.01),
         recovered_rates = ((1000*recovered/population) +0.01),
         dead_rates = ((1000*death/population) +0.01)) %>% 
  select(-c(2:7)) %>% 
  pivot_longer(2:5, 
               names_to = "type", 
               values_to = "rate") %>% 
  mutate(rate = round(rate,4)) %>% 
  pivot_wider(names_from = month, 
              values_from = rate)
  
```

```{r rate, fig.cap="The rates for confirmed cases, deaths, recovered cases and active rates of COVID-19 in China from January to August. All the rates were added by 0.1."}

as.datatable(formattable(covid_rate , 
              align =c("r",rep("c", NCOL(covid_rate) - 1)),
              list(`type` = formatter("span", style = ~formattable::style(color = "grey", font.weight = "bold")), 
                   `Feb`= formatter("span", style = ~ formattable::style(color = ifelse(`Feb` >`Jan`, "#EF6351", "#7AC5CD"), font.weight = "bold")),
                   `Mar`= formatter("span", style = ~ formattable::style(color = ifelse(`Mar` >`Feb`, "#EF6351", "#7AC5CD"), font.weight = "bold")),
                   `Apr`= formatter("span", style = ~ formattable::style(color = ifelse(`Apr` >`Mar`, "#EF6351", "#7AC5CD"), font.weight = "bold")),
                   `May`= formatter("span", style = ~ formattable::style(color = ifelse(`May` >`Apr`, "#EF6351", "#7AC5CD"), font.weight = "bold")),
                   `Jun`= formatter("span", style = ~ formattable::style(color = ifelse(`Jun` >`May`, "#EF6351", "#7AC5CD"), font.weight = "bold")),
                   `Jul`= formatter("span", style = ~ formattable::style(color = ifelse(`Jul` >`Jun`, "#EF6351", "#7AC5CD"), font.weight = "bold")),
                   `Aug`= formatter("span", style = ~ formattable::style(color = ifelse(`Aug` >`Jul`, "#EF6351", "#7AC5CD"), font.weight = "bold"))
                   ),
             rownames = FALSE,
             option = list(dom = 't')))
```



```{r death}
# find the outlier for death
death_outlier <- covid19_chn %>% 
  pivot_wider(names_from = type, values_from = cases) %>% 
  group_by(month, province) %>% 
  summarise(death = sum(death)) %>% 
  filter(month == "Apr") %>% 
  arrange(-death) %>% 
  head(3) %>% 
  kable(caption = "The top 3 deaths for province of COVID-19 on April in China") %>% 
  kable_styling(bootstrap_options = 
                  c("striped", "condensed"), 
                  full_width = F, 
                  position = "center",
                  latex_options = c("hold_position")) %>% 
    row_spec(1, 
             bold = T, 
             color = "white", 
             background = "#7AC5CD")

death_outlier
```


